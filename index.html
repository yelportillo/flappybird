import pygame
import random
import sys

pygame.init()
pygame.mixer.init()

# Screen setup
SCREEN_WIDTH = 500
SCREEN_HEIGHT = 700
SCREEN = pygame.display.set_mode((SCREEN_WIDTH, SCREEN_HEIGHT))
pygame.display.set_caption("Flappy Bird")
clock = pygame.time.Clock()
FPS = 60

# Colors & Fonts
WHITE = (255, 255, 255)
BUTTON_COLOR = (0, 150, 0)
TITLE_FONT = pygame.font.SysFont("comicsansms", 60)
BUTTON_FONT = pygame.font.SysFont("comicsansms", 30)
SCORE_FONT = pygame.font.SysFont("comicsansms", 40)

# Game variables
GRAVITY = 0.5
FLAP_STRENGTH = -10
PIPE_SPEED = 3
PIPE_WIDTH = 120
PIPE_GAP = 200
COLLISION_PADDING = 5

# Leaderboard
leaderboard = []

# Load assets
BIRD_IMG = pygame.image.load("assets/bird.png").convert_alpha()
PIPE_IMG = pygame.image.load("assets/pipe.png").convert_alpha()
BACKGROUND_IMG = pygame.image.load("assets/background.png").convert_alpha()

# Scale bird keeping aspect ratio
BIRD_WIDTH = 40
BIRD_HEIGHT = int(BIRD_WIDTH * BIRD_IMG.get_height() / BIRD_IMG.get_width())
BIRD_IMG = pygame.transform.scale(BIRD_IMG, (BIRD_WIDTH, BIRD_HEIGHT))

# Sounds
WING_SOUND = pygame.mixer.Sound("assets/sounds/wing.wav")
HIT_SOUND = pygame.mixer.Sound("assets/sounds/hit.wav")
POINT_SOUND = pygame.mixer.Sound("assets/sounds/point.wav")

# Classes
class Bird:
    def __init__(self):
        self.x = SCREEN_WIDTH // 5
        self.y = SCREEN_HEIGHT // 2
        self.width = BIRD_WIDTH
        self.height = BIRD_HEIGHT
        self.velocity = 0
        self.rect = pygame.Rect(self.x, self.y, self.width, self.height)

    def flap(self):
        self.velocity = FLAP_STRENGTH
        WING_SOUND.play()

    def update(self):
        self.velocity += GRAVITY
        self.y += self.velocity
        self.rect.y = int(self.y)

    def draw(self, screen):
        screen.blit(BIRD_IMG, (self.x, self.y))

    def hitbox(self):
        return pygame.Rect(
            self.rect.x + COLLISION_PADDING,
            self.rect.y + COLLISION_PADDING,
            self.rect.width - 2 * COLLISION_PADDING,
            self.rect.height - 2 * COLLISION_PADDING
        )

class Pipe:
    def __init__(self, x):
        self.x = x
        self.width = PIPE_WIDTH
        self.top_height = random.randint(50, SCREEN_HEIGHT - PIPE_GAP - 50)
        self.bottom_y = self.top_height + PIPE_GAP
        self.passed = False
        self.top_rect = pygame.Rect(self.x, 0, self.width, self.top_height)
        self.bottom_rect = pygame.Rect(self.x, self.bottom_y, self.width, SCREEN_HEIGHT - self.bottom_y)

    def update(self):
        self.x -= PIPE_SPEED
        self.top_rect.x = int(self.x)
        self.bottom_rect.x = int(self.x)

    def draw(self, screen):
        top_pipe_img = pygame.transform.flip(PIPE_IMG, False, True)
        top_pipe_scaled = pygame.transform.scale(top_pipe_img, (self.width, self.top_height))
        screen.blit(top_pipe_scaled, (self.x, 0))
        bottom_pipe_scaled = pygame.transform.scale(PIPE_IMG, (self.width, SCREEN_HEIGHT - self.bottom_y))
        screen.blit(bottom_pipe_scaled, (self.x, self.bottom_y))

# Buttons
def draw_button(screen, x, y, width, height, text):
    pygame.draw.rect(screen, BUTTON_COLOR, (x, y, width, height), border_radius=10)
    text_surface = BUTTON_FONT.render(text, True, WHITE)
    screen.blit(text_surface, (x + width // 2 - text_surface.get_width() // 2,
                               y + height // 2 - text_surface.get_height() // 2))

# Leaderboard display
def draw_leaderboard(screen):
    start_y = SCREEN_HEIGHT//2 + 50
    top_scores = sorted(leaderboard, key=lambda x: x[1], reverse=True)[:5]
    for idx, (name, score) in enumerate(top_scores):
        text = SCORE_FONT.render(f"{idx+1}. {name} - {score}", True, WHITE)
        screen.blit(text, (SCREEN_WIDTH//2 - text.get_width()//2, start_y + idx*40))

# Input name after Game Over
def get_player_name():
    name = ""
    active = True
    box_width, box_height = 300, 50
    input_box = pygame.Rect(SCREEN_WIDTH//2 - box_width//2, SCREEN_HEIGHT//2, box_width, box_height)
    while active:
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                pygame.quit()
                sys.exit()
            if event.type == pygame.KEYDOWN:
                if event.key == pygame.K_RETURN and name.strip():
                    active = False
                    return name.strip()
                elif event.key == pygame.K_BACKSPACE:
                    name = name[:-1]
                else:
                    if len(name) < 12:
                        name += event.unicode

        SCREEN.fill((0,0,0))
        SCREEN.blit(pygame.transform.scale(BACKGROUND_IMG, (SCREEN_WIDTH, SCREEN_HEIGHT)), (0,0))

        # Prompt
        prompt = SCORE_FONT.render("Enter your name:", True, WHITE)
        SCREEN.blit(prompt, (SCREEN_WIDTH//2 - prompt.get_width()//2, SCREEN_HEIGHT//2 - 60))

        # Input box
        pygame.draw.rect(SCREEN, WHITE, input_box, 2, border_radius=8)

        # Text inside box
        text_surface = SCORE_FONT.render(name, True, WHITE)
        text_x = input_box.x + (input_box.width - text_surface.get_width()) // 2
        text_y = input_box.y + (input_box.height - text_surface.get_height()) // 2
        SCREEN.blit(text_surface, (text_x, text_y))

        pygame.display.update()
        clock.tick(FPS)

# Main game
def main():
    run = True
    game_state = "menu"
    bird = Bird()
    pipes = []
    spawn_timer = 0
    score = 0

    while run:
        SCREEN.fill((0,0,0))
        SCREEN.blit(pygame.transform.scale(BACKGROUND_IMG, (SCREEN_WIDTH, SCREEN_HEIGHT)), (0, 0))

        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                run = False
                pygame.quit()
                sys.exit()
            if event.type == pygame.KEYDOWN or event.type == pygame.MOUSEBUTTONDOWN:
                if game_state == "menu":
                    game_state = "playing"
                    bird = Bird()
                    pipes = []
                    spawn_timer = 0
                    score = 0
                elif game_state == "playing":
                    bird.flap()

        if game_state == "menu":
            title_text = TITLE_FONT.render("Flappy Bird", True, WHITE)
            SCREEN.blit(title_text, (SCREEN_WIDTH//2 - title_text.get_width()//2, SCREEN_HEIGHT//4))
            draw_button(SCREEN, SCREEN_WIDTH//2 - 75, SCREEN_HEIGHT//2, 150, 60, "PLAY")
            draw_leaderboard(SCREEN)

        elif game_state == "playing":
            bird.update()
            bird.draw(SCREEN)

            spawn_timer += 1
            if spawn_timer > 90:
                pipes.append(Pipe(SCREEN_WIDTH))
                spawn_timer = 0

            for pipe in pipes:
                pipe.update()
                pipe.draw(SCREEN)

                if bird.hitbox().colliderect(pipe.top_rect) or bird.hitbox().colliderect(pipe.bottom_rect):
                    HIT_SOUND.play()
                    game_state = "gameover"

                if not pipe.passed and pipe.x + pipe.width < bird.x:
                    pipe.passed = True
                    score += 1
                    POINT_SOUND.play()

            pipes = [pipe for pipe in pipes if pipe.x + pipe.width > 0]

            if bird.y + bird.height >= SCREEN_HEIGHT or bird.y <= 0:
                HIT_SOUND.play()
                game_state = "gameover"

            score_text = SCORE_FONT.render(str(score), True, WHITE)
            SCREEN.blit(score_text, (20, 20))

        elif game_state == "gameover":
            # Display Game Over and score
            SCREEN.fill((0,0,0))
            SCREEN.blit(pygame.transform.scale(BACKGROUND_IMG, (SCREEN_WIDTH, SCREEN_HEIGHT)), (0,0))
            gameover_text = TITLE_FONT.render("GAME OVER", True, WHITE)
            SCREEN.blit(gameover_text, (SCREEN_WIDTH//2 - gameover_text.get_width()//2, SCREEN_HEIGHT//4))
            score_text = SCORE_FONT.render(f"Score: {score}", True, WHITE)
            SCREEN.blit(score_text, (SCREEN_WIDTH//2 - score_text.get_width()//2, SCREEN_HEIGHT//2))
            pygame.display.update()

            # Automatically prompt for name
            player_name = get_player_name()
            leaderboard.append((player_name, score))

            # Reset game to menu
            game_state = "menu"
            bird = Bird()
            pipes = []
            spawn_timer = 0
            score = 0

        pygame.display.update()
        clock.tick(FPS)

if __name__ == "__main__":
    main()
